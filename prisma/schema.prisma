generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}


model AdminUser{
  id String @id @default(uuid())
  email String @unique
  passwordHash String

  lastUpdatedCategory Category[]
  lastUpdatedProducts    Product[]
  lastUpdatedPosts       Recipe[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Category {
  id        String   @id @default(uuid())
  publicId  String   @unique @default(dbgenerated("concat('category_', gen_random_uuid())"))
  name      String
  displayName String
  slug      String   @unique
  description String?

  products  CategoryProduct[] 

  lastUpdatedById String?
  lastUpdatedBy AdminUser?  @relation(fields: [lastUpdatedById],references: [id])


  isPublished  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([publicId])
  @@index([slug])
  @@index([isPublished])
}



model Product {
  // identifier
  id        String   @id @default(uuid())
  publicId  String   @unique @default(dbgenerated("concat('product_', gen_random_uuid())"))
  sku       String   @unique
  slug      String   @unique

  //  about the product
  name      String
  displayName String
  type       String
  description String? @default("")
  assets     ProductAsset[]
  categories CategoryProduct[]
  orderedIn  OrderProduct[]
  addedToCart CartProduct[]
  linkedRecipes RecipeProduct[] 
  wishList   UserWishlist[]



  // pricing
  price     Int   // selling price
  mrp       Int   // original price
  currency  String  @default("INR")
  
  
  // weight 
  weight    Int @default(0)
  weightUnit  String @default("g")

  // dimension
  height    Int @default(0)
  width     Int @default(0)
  breadth   Int @default(0)
  dimension  String @default("cm")

  /// serving size value
  servingSize Int @default(0)

  /// serving unit (g / ml)
  servingUnit String @default("g")


  // benefits
  healthBenefits String[]
  
  // nutrition (per serving or per 100g)
  /// calories in kilocalories (kcal)
  nutritionalInfo Json?
  // visibility
  inStock    Boolean @default(true)
  isPublished Boolean @default(true)
  isFeatured  Boolean @default(false)

  quantity Int @default(0)

  lastUpdatedById String?
  lastUpdatedBy AdminUser?  @relation(fields: [lastUpdatedById],references: [id])


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([publicId])
  @@index([slug])
  @@index([sku])
  @@index([inStock])
  @@index([isPublished])
  @@index([isFeatured])
}

model CategoryProduct {
  category   Category @relation(fields: [categoryId], references: [id],onDelete: Cascade)
  categoryId String
  product      Product @relation(fields: [productId], references: [id],onDelete: Cascade)
  productId    String
  
  @@id([categoryId, productId])
  @@index([productId])
  @@index([categoryId])
}

model ProductAsset {
  id String @id @default(uuid())
  product      Product @relation(fields: [productId], references: [id],onDelete: Cascade)
  productId    String
  url     String
  thumbnail    String
  type AssetType @default(IMAGE)
  position     Int @default(0)
  isPrimary    Boolean @default(false)

  @@index([productId])
  @@index([isPrimary])
}

enum CartStatus{
  ACTIVE 
  CONVERTED
}

model Cart{
  id String @id @default(uuid())
  sessionId String @unique @default(dbgenerated("concat('session_', gen_random_uuid())"))
  publicId String @unique @default(dbgenerated("concat('cart_', gen_random_uuid())"))
  userIdentifier  String?
  status CartStatus @default(ACTIVE)
  products CartProduct[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([publicId])
  @@index([sessionId])
  @@index([status])
}

model CartProduct{
  cart        Cart @relation(fields: [cartId], references: [id])
  cartId      String
  product      Product @relation(fields: [productId], references: [id])
  productId    String
  quantity  Int     @default(1)

  @@id([cartId, productId])
  @@index([productId])
  @@index([cartId])
}

enum OrderStatus {
  PENDING      
  FAILED       
  ON_HOLD      
  PROCESSING   
  SHIPPED      
  DELIVERED    
  CANCELLED    
  REFUNDED     
}

model Order{
  id String @id @default(uuid())
  publicId String @unique @default(dbgenerated("concat('order_', gen_random_uuid())"))
  products OrderProduct[]
  status OrderStatus @default(PENDING)
  deliveryFee Int
  subTotal Int
  tax Int
  total Int 
  currency  String @default("INR")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt


  @@index([publicId])
  @@index([createdAt])
}

model OrderProduct {
  orderId   String
  productId String

  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])

  quantity  Int     @default(1)
  price     Int     
  currency  String @default("INR")

  @@id([orderId, productId])
  @@index([productId])
  @@index([orderId])
}


enum AssetType{
  IMAGE 
  VIDEO
}
model Recipe{
  id String @id @default(uuid())
  publicId String @unique  @default(dbgenerated("concat('post_', gen_random_uuid())"))
  slug String @unique

  title String @db.Text
  summary String @db.Text
  

  tags String[] 
  instructions String[]
  chefTips    String[]
  ingredients String[]
  nutritionalInfo Json?
  recipeSaves RecipeSaves[]

  cookingTime String @default("")
  difficulty String @default("")
  serving String @default("") 
  prepTime String @default("")
  
  linkedProducts RecipeProduct[] 
  healthBenefits String[]
  assets RecipeAsset[]

  isPublished Boolean @default(true)

  lastUpdatedById String? 
  lastUpdatedBy AdminUser? @relation(fields: [lastUpdatedById],references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([publicId])
  @@index([isPublished])
}

model RecipeProduct {
  recipe       Recipe @relation(fields: [recipeId], references: [id],onDelete: Cascade)
  recipeId     String
  product      Product @relation(fields: [productId], references: [id],onDelete: Cascade)
  productId    String
  quantity     Int      @default(1)
  @@id([recipeId, productId])
  @@index([productId])
  @@index([recipeId])
}



model RecipeAsset{
  id String @id @default(uuid())
  recipeId String 
  recipe Recipe @relation(fields: [recipeId],references: [id],onDelete: Cascade)
  url String
  thumbnail String
  position     Int @default(0)
  isPrimary    Boolean @default(false)
  type AssetType @default(IMAGE)
}


model UserOTP{
  id String @id @default(uuid())

  phone String @unique 
  otp String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}




model RecipeSaves{
  phone String
  recipeId String 
  recipe Recipe @relation(references:[id],fields:[recipeId])

  @@id([phone,recipeId])
}

model UserWishlist{
  phone String
  productId String 
  product Product @relation(references:[id],fields:[productId])

  @@id([phone,productId])
}