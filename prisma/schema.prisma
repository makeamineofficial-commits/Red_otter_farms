generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}


model AdminUser{
  id String @id @default(uuid())
  email String @unique
  passwordHash String

  lastUpdatedCategory Category[]
  lastUpdatedProducts    Product[]
  lastUpdatedPosts       Recipe[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Category {
  id        String   @id @default(uuid())
  publicId  String   @unique @default(dbgenerated("concat('category_', gen_random_uuid())"))
  name      String
  displayName String
  slug      String   @unique
  description String?

  products  CategoryProduct[] 

  lastUpdatedById String?
  lastUpdatedBy AdminUser?  @relation(fields: [lastUpdatedById],references: [id])

  quickShop Boolean @default(false)
  isPublished  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([publicId])
  @@index([slug])
  @@index([isPublished])
}


model CategoryProduct {
  category   Category @relation(fields: [categoryId], references: [id],onDelete: Cascade)
  categoryId String
  product      Product @relation(fields: [productId], references: [id],onDelete: Cascade)
  productId    String
  
  @@id([categoryId, productId])
  @@index([productId])
  @@index([categoryId])
}

model Product {
  // identifier
  id        String   @id @default(uuid())
  publicId  String   @unique @default(dbgenerated("concat('product_', gen_random_uuid())"))
  slug      String   @unique


  //  about the product
  name      String
  displayName String
  summary String?  @default("")
  description String? @default("")  @db.Text
  assets   ProductAsset[]

  categories CategoryProduct[]
  wishList   UserWishlist[]
  healthBenefits String[]


  minPrice Int @default(0)
  maxPrice Int @default(0)

  // variants
  options Option[]
  variants Variant[]
  faqs ProductFAQ[]

  type       String
  nutritionalInfo Json?

  isPublished Boolean @default(true)
  isFeatured  Boolean @default(false)
  isDryStore Boolean @default(false)

  lastUpdatedById String?
  lastUpdatedBy AdminUser?  @relation(fields: [lastUpdatedById],references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt


  @@index([isFeatured])
}


model ProductFAQ{
  id String @id @default(uuid())
  productId String 
  product Product @relation(fields: [productId],references: [id],onDelete: Cascade)
  question String
  answer String 
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Option{
  id String @id @default(uuid())
  displayName String
  slug String  @unique
  productId String 
  product Product @relation(fields: [productId],references: [id],onDelete: Cascade)
  values OptionValue[]
  @@unique([productId,slug])
}

model OptionValue{
  id String @id @default(uuid())
  displayName String
  optionId String 
  option Option @relation(fields: [optionId],references: [id],onDelete: Cascade)
  variants VariantOptionMap[]
  slug String  @unique
  isDefault Boolean @default(false)
  @@unique([slug,optionId])
}

model Variant{


  id        String   @id @default(uuid())
  publicId  String   @unique @default(dbgenerated("concat('variant_', gen_random_uuid())"))
  sku       String   @unique

  productId String 
  product Product @relation(fields: [productId],references: [id] ,onDelete: Cascade)

  name      String
  // pricing
  price     Int   // selling price
  mrp       Int   // original price
  currency  String  @default("INR")
  

  weight    Int @default(0)   
  weightUnit  String @default("g")


  // dimension
  length Int @default(0)
  lengthUnit String @default("mm")

  breadth Int @default(0)
  breadthUnit String @default("mm")

  height Int @default(0)
  heightUnit String @default("mm")


  availableInStock Int   @default(0)   // from in stock count
  stockLimit       Int   @default(5)   // reserved to show low in stock banner
  inStock    Boolean @default(true)  // to mark out of stock
 
  presentInCart CartItem[]
  options VariantOptionMap[] 

  listedIngredients RecipeIngredient[] 

  isPublished Boolean @default(true)
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  
  @@index([isPublished])
  @@index([inStock])
}

model ProductAsset {
  id String @id @default(uuid())
  product   Product @relation(fields: [productId], references: [id],onDelete: Cascade)
  productId    String
  url     String
  thumbnail    String
  type AssetType @default(IMAGE)
  position     Int @default(0)
  isPrimary    Boolean @default(false)

  @@index([productId])
  @@index([isPrimary])
}

model VariantOptionMap {
  variantId String
  valueId   String

  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  value   OptionValue   @relation(fields: [valueId], references: [id], onDelete: Cascade)

  @@id([variantId, valueId])
  @@index([valueId])
    @@index([variantId])
}


enum CartStatus{
  ACTIVE 
  CHECKEDOUT
  CONVERTED
}

model Cart{
  id String @id @default(uuid())
  sessionId String @unique @default(dbgenerated("concat('session_', gen_random_uuid())"))
  publicId String @unique @default(dbgenerated("concat('cart_', gen_random_uuid())"))
  userIdentifier  String?
  status CartStatus @default(ACTIVE)
  items CartItem[]

  shipping Json?
  billing Json?
  paymentId String?

  order Order? @relation("cart_to_order")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([publicId])
  @@index([sessionId])
  @@index([status])
}

model CartItem{
  cart        Cart @relation(fields: [cartId], references: [id],onDelete: Cascade)
  cartId      String
  variant      Variant @relation(fields: [variantId], references: [id],onDelete: Cascade)
  variantId    String
  quantity  Int     @default(1)

  @@id([cartId, variantId])
  @@index([variantId])
  @@index([cartId])
}


enum OrderStatus {
  CREATED

  PROCESSING 

  FAILED            
  PLACED  

  REFUNDED

  CANCELLED
}

model Order{
  id String @id @default(uuid())
  publicId String @unique @default(dbgenerated("concat('order_', gen_random_uuid())"))
  
  userIdentifier String  

  cartId String  @unique
  cart Cart  @relation("cart_to_order",fields: [cartId],references: [id] ,onDelete: Cascade)

  status OrderStatus  @default(CREATED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

}

enum PaymentStatus {
  CREATED
  PENDING     


  IN_PROGRESS 
  PROCESSING 


  FAILED            
  VERIFIED   
  REFUNDED
  UNDERPAID
  OVERPAID     
  EXPIRED 
  CANCELLED
}

enum PaymentPurpose {
    ORDER   
}


model Payment {
  id String @id @default(uuid())
  publicId String @unique @default(dbgenerated("concat('payment_', gen_random_uuid())"))

  referenceId String 

  purpose PaymentPurpose

  amount Int
  currency String @default("INR")

  status PaymentStatus @default(CREATED)

  razorpayOrderId String?
  razorpayPaymentId String? 
  razorpayEvent String?

  method String?
  provider String?

  errorCode String?
  errorDescription String?

  refundId String?
  refundAmount Int?
  refundedAt DateTime?

  rawWebhook Json?

  paidAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}




enum AssetType{
  IMAGE 
  VIDEO
}
model Recipe{
  id String @id @default(uuid())
  publicId String @unique  @default(dbgenerated("concat('post_', gen_random_uuid())"))
  slug String @unique

  title String @db.Text
  summary String @db.Text
  

  tags String[] 
  instructions String[]
  chefTips    String[]
  ingredients String[]
  nutritionalInfo Json?
  recipeSaves RecipeSaves[]

  cookingTime String @default("")
  difficulty String @default("")
  serving String @default("") 
  prepTime String @default("")
  
  listedIngredients RecipeIngredient[] 
  healthBenefits String[]
  assets RecipeAsset[]

  isPublished Boolean @default(true)

  lastUpdatedById String? 
  lastUpdatedBy AdminUser? @relation(fields: [lastUpdatedById],references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([publicId])
  @@index([isPublished])
}

model RecipeIngredient {
  recipe       Recipe @relation(fields: [recipeId], references: [id],onDelete: Cascade)
  recipeId     String
  variant      Variant @relation(fields: [variantId], references: [id],onDelete: Cascade)
  variantId    String
  quantity     Int      @default(1)
  @@id([recipeId, variantId])
  @@index([variantId])
  @@index([recipeId])
}



model RecipeAsset{
  id String @id @default(uuid())
  recipeId String 
  recipe Recipe @relation(fields: [recipeId],references: [id],onDelete: Cascade)
  url String
  thumbnail String
  position     Int @default(0)
  isPrimary    Boolean @default(false)
  type AssetType @default(IMAGE)
}


model UserOTP{
  id String @id @default(uuid())

  phone String @unique 
  otp String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}




model RecipeSaves{
  phone String
  recipeId String 
  recipe Recipe @relation(references:[id],fields:[recipeId],onDelete: Cascade)

  @@id([phone,recipeId])
}

model UserWishlist{
  phone String
  productId String 
  product Product @relation(references:[id],fields:[productId],onDelete: Cascade)

  @@id([phone,productId])
}



enum AddressLabelEnum{
  HOME
  WORK
  CUSTOM
}
model AddressLabel{
  id String @id @default(uuid())
  addressId String @unique
  label AddressLabelEnum @default(HOME)
  customLabel String?

}

enum AddressTagEnum{
  BILLING
  SHIPPING
  NONE
}

model AddressTag{
  id String @id @default(uuid())
  addressId String @unique
  tag AddressTagEnum
  customerId String

  @@unique([addressId,customerId])
}


model Testimonial{
  id String @id @default(uuid())
  publicId String @unique @default(dbgenerated("concat('testimonial_', gen_random_uuid())"))
  slug String @unique
  heroImage TestimonialAsset[]
  review String @db.Text
  rating Int @default(0)
  
  isPublished Boolean @default(true)
  
  avatar TestimonialUserAsset[]
  name String
  position String


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TestimonialAsset{
  id String @id @default(uuid())
  testimonialId String 
  testimonial Testimonial @relation(fields: [testimonialId],references: [id],onDelete: Cascade)
  url String
  thumbnail String
  position     Int @default(0)
  isPrimary    Boolean @default(false)
  type AssetType @default(IMAGE)
}


model TestimonialUserAsset{
  id String @id @default(uuid())
  testimonialId String 
  testimonial Testimonial @relation(fields: [testimonialId],references: [id],onDelete: Cascade)
  url String
  thumbnail String
  position     Int @default(0)
  isPrimary    Boolean @default(false)
  type AssetType @default(IMAGE)
}


model HealthBenefit{
  id String @id @default(uuid())
  label String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}